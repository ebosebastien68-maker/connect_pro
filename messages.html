<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        .messages-wrapper { height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        .messages-header { 
            background: white; 
            padding: 12px 20px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            z-index: 100; 
        }
        .messages-header h1 { 
            color: #050505; 
            font-size: 24px; 
            font-weight: 700;
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .messages-header h1 i { color: #0084ff; }
        
        .header-actions { display: flex; gap: 8px; }
        .action-btn { 
            background: #0084ff; 
            color: white; 
            border: none; 
            padding: 10px 18px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            transition: all 0.2s; 
            font-size: 14px; 
        }
        .action-btn:hover { 
            background: #006dcc;
            transform: scale(1.02);
        }
        .action-btn.secondary { 
            background: #e4e6eb; 
            color: #050505; 
        }
        .action-btn.secondary:hover { 
            background: #d8dadf; 
        }
        
        /* Container principal */
        .messages-container { 
            flex: 1; 
            overflow: hidden; 
            background: white; 
            margin: 12px; 
            border-radius: 12px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            position: relative; 
        }
        
        /* Zone de chat principale */
        .chat-area { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        
        .chat-header { 
            padding: 12px 16px; 
            border-bottom: 1px solid #e4e6eb; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            background: white;
            flex-shrink: 0; 
        }
        .chat-avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #0084ff 0%, #00c6ff 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: 700; 
            font-size: 15px; 
            flex-shrink: 0; 
            position: relative;
        }
        .chat-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: #31a24c;
            border: 2px solid white;
            border-radius: 50%;
        }
        .chat-user-info { flex: 1; }
        .chat-user-info h3 { 
            color: #050505; 
            font-size: 15px; 
            font-weight: 600;
            margin-bottom: 2px; 
        }
        .chat-user-info p { 
            color: #65676b; 
            font-size: 12px; 
        }
        .typing-indicator {
            color: #0084ff;
            font-size: 12px;
            font-weight: 500;
        }
        .typing-indicator .dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #0084ff;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }
        
        .chat-header-actions {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }
        .chat-header-btn {
            background: #f0f2f5;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #050505;
            font-size: 16px;
            transition: background 0.2s;
        }
        .chat-header-btn:hover {
            background: #e4e6eb;
        }
        
        /* Messages */
        .chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 16px; 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            background: white;
            min-height: 0;
            scroll-behavior: smooth;
        }
        
        .message-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 8px;
        }
        
        .message-bubble { 
            max-width: 60%; 
            padding: 8px 12px; 
            border-radius: 18px; 
            word-wrap: break-word; 
            animation: messageSlideIn 0.2s ease;
            position: relative;
        }
        @keyframes messageSlideIn { 
            from { opacity: 0; transform: translateY(10px) scale(0.95); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .message-sent { 
            align-self: flex-end; 
            background: #0084ff; 
            color: white; 
        }
        .message-sent.first-in-group { border-top-right-radius: 18px; }
        .message-sent.last-in-group { border-bottom-right-radius: 4px; }
        .message-sent.middle-in-group { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        
        .message-received { 
            align-self: flex-start; 
            background: #f0f2f5; 
            color: #050505; 
        }
        .message-received.first-in-group { border-top-left-radius: 18px; }
        .message-received.last-in-group { border-bottom-left-radius: 4px; }
        .message-received.middle-in-group { border-top-left-radius: 4px; border-bottom-left-radius: 4px; }
        
        .message-text { 
            line-height: 1.4; 
            font-size: 15px; 
            white-space: pre-wrap;
        }
        .message-time { 
            font-size: 11px; 
            opacity: 0.6; 
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .message-status {
            font-size: 10px;
        }
        .message-image { 
            max-width: 100%; 
            max-height: 300px; 
            border-radius: 12px; 
            margin-top: 4px; 
            cursor: pointer;
            transition: transform 0.2s;
        }
        .message-image:hover {
            transform: scale(1.02);
        }
        
        /* Réactions */
        .message-reactions {
            position: absolute;
            bottom: -12px;
            right: 8px;
            background: white;
            border: 1px solid #e4e6eb;
            border-radius: 12px;
            padding: 2px 6px;
            display: flex;
            gap: 2px;
            font-size: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-sent .message-reactions {
            right: auto;
            left: 8px;
        }
        
        .reaction-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border-radius: 24px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            gap: 4px;
            margin-bottom: 8px;
            z-index: 10;
        }
        .message-bubble:hover .reaction-picker {
            display: flex;
        }
        .reaction-emoji {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .reaction-emoji:hover {
            transform: scale(1.3);
            background: #f0f2f5;
        }
        
        /* Animation de réaction (comme Messenger) */
        .big-reaction-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 120px;
            z-index: 9999;
            pointer-events: none;
            animation: bigReaction 1s ease-out forwards;
        }
        @keyframes bigReaction {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(15deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8) translateY(-100px); opacity: 0; }
        }
        
        /* Input de message */
        .chat-input-area { 
            padding: 12px 16px; 
            border-top: 1px solid #e4e6eb; 
            display: flex; 
            gap: 8px; 
            align-items: flex-end; 
            background: white; 
            flex-shrink: 0; 
        }
        .attach-btn { 
            background: transparent;
            border: none; 
            color: #0084ff; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            font-size: 20px; 
            cursor: pointer; 
            transition: all 0.2s; 
            flex-shrink: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .attach-btn:hover { 
            background: #f0f2f5;
        }
        
        .input-wrapper { 
            flex: 1; 
            position: relative; 
            display: flex; 
            align-items: center;
            background: #f0f2f5;
            border-radius: 20px;
            padding: 0 12px;
        }
        .message-input { 
            width: 100%; 
            padding: 10px 0;
            border: none;
            background: transparent;
            font-size: 15px; 
            font-family: inherit;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }
        .message-input:focus { 
            outline: none;
        }
        
        .emoji-btn {
            background: transparent;
            border: none;
            color: #0084ff;
            font-size: 20px;
            cursor: pointer;
            padding: 0 4px;
        }
        
        .send-btn { 
            background: transparent;
            color: #0084ff; 
            border: none; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 20px; 
            flex-shrink: 0; 
            transition: all 0.2s; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .send-btn:hover:not(:disabled) { 
            background: #f0f2f5;
        }
        .send-btn:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
        }
        
        /* État vide */
        .empty-state { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: #65676b; 
            background: white;
        }
        .empty-state i { 
            font-size: 64px; 
            margin-bottom: 16px; 
            color: #e4e6eb; 
        }
        .empty-state h3 { 
            font-size: 20px; 
            color: #050505; 
            margin-bottom: 8px; 
            font-weight: 600;
        }
        .empty-state p { 
            font-size: 14px; 
        }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal.show { display: flex; }
        .modal-content { 
            background: white; 
            border-radius: 12px; 
            width: 95%; 
            max-width: 500px; 
            max-height: 85vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            animation: modalSlide 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 12px 28px rgba(0,0,0,0.3);
        }
        @keyframes modalSlide { 
            from { opacity: 0; transform: scale(0.8) translateY(20px); } 
            to { opacity: 1; transform: scale(1) translateY(0); } 
        }
        
        .modal-header { 
            padding: 16px 20px; 
            border-bottom: 1px solid #e4e6eb; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: white;
        }
        .modal-header h3 { 
            font-size: 20px; 
            font-weight: 700;
            color: #050505;
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .close-modal { 
            background: #f0f2f5;
            border: none; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            font-size: 20px; 
            color: #050505; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .close-modal:hover { 
            background: #e4e6eb;
        }
        
        .modal-search { 
            padding: 12px 16px; 
            border-bottom: 1px solid #e4e6eb; 
        }
        .modal-search input { 
            width: 100%; 
            padding: 10px 16px 10px 40px; 
            border: none;
            border-radius: 20px; 
            font-size: 15px; 
            background: #f0f2f5;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%2365676b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>');
            background-repeat: no-repeat;
            background-position: 12px center;
        }
        .modal-search input:focus { 
            outline: none;
            background-color: white;
            box-shadow: 0 0 0 2px #e4e6eb;
        }
        
        .list-container { 
            flex: 1; 
            overflow-y: auto; 
        }
        .list-item { 
            padding: 12px 16px; 
            border-bottom: 1px solid #f0f2f5; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: background 0.2s; 
        }
        .list-item:hover { 
            background: #f0f2f5;
        }
        .list-item.active { 
            background: #e7f3ff;
        }
        
        .item-avatar { 
            width: 56px; 
            height: 56px; 
            border-radius: 50%; 
            background: linear-gradient(135deg, #0084ff 0%, #00c6ff 100%); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: 700; 
            font-size: 20px; 
            flex-shrink: 0;
            position: relative;
        }
        .item-avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            background: #31a24c;
            border: 3px solid white;
            border-radius: 50%;
        }
        .item-info { 
            flex: 1; 
            min-width: 0; 
        }
        .item-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 4px; 
        }
        .item-name { 
            font-weight: 600; 
            color: #050505; 
            font-size: 15px; 
        }
        .item-role { 
            font-size: 11px; 
            color: #0084ff; 
            background: #e7f3ff; 
            padding: 2px 8px; 
            border-radius: 10px;
            font-weight: 600;
        }
        .item-time { 
            font-size: 13px; 
            color: #65676b; 
        }
        .item-preview { 
            font-size: 13px; 
            color: #65676b; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .item-preview.unread {
            color: #050505;
            font-weight: 600;
        }
        .item-unread { 
            background: #0084ff; 
            color: white; 
            border-radius: 12px; 
            padding: 2px 8px; 
            font-size: 12px; 
            font-weight: 700; 
            flex-shrink: 0;
            min-width: 20px;
            text-align: center;
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: #65676b; 
        }
        .loading i { 
            font-size: 32px; 
            margin-bottom: 12px;
        }
        
        /* Scrollbar personnalisée */
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { 
            background: #ccd0d5; 
            border-radius: 10px; 
        }
        .chat-messages::-webkit-scrollbar-thumb:hover { 
            background: #b0b3b8; 
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f0f2f5; }
        ::-webkit-scrollbar-thumb { 
            background: #ccd0d5; 
            border-radius: 4px; 
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: #b0b3b8; 
        }
        
        /* Message date separator */
        .date-separator {
            text-align: center;
            margin: 16px 0;
            position: relative;
        }
        .date-separator span {
            background: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: #65676b;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        /* Preview d'image avant envoi */
        .image-preview-container {
            padding: 12px;
            border-top: 1px solid #e4e6eb;
            background: #f0f2f5;
            display: none;
        }
        .image-preview {
            position: relative;
            display: inline-block;
        }
        .image-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
        }
        .remove-preview {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .messages-header h1 { font-size: 20px; }
            .action-btn span { display: none; }
            .message-bubble { max-width: 80%; }
            .modal-content { max-width: 100%; border-radius: 0; max-height: 100vh; }
        }
    </style>
</head>
<body>
    <div class="messages-wrapper">
        <div class="messages-header">
            <h1><i class="fas fa-comments"></i> <span id="header-title">Messagerie</span></h1>
            <div class="header-actions">
                <button class="action-btn secondary" onclick="openConversationsModal()">
                    <i class="fas fa-list"></i>
                    <span>Conversations</span>
                </button>
                <button class="action-btn" onclick="openContactsModal()">
                    <i class="fas fa-user-plus"></i>
                    <span id="contacts-btn-text">Contacts</span>
                </button>
            </div>
        </div>

        <div class="messages-container">
            <div class="chat-area" id="chat-area">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <h3>Chargement...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conversations -->
    <div class="modal" id="conversations-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-comments"></i> Conversations récentes</h3>
                <button class="close-modal" onclick="closeConversationsModal()">×</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher une conversation..." id="search-conversations">
            </div>
            <div class="list-container" id="conversations-list"></div>
        </div>
    </div>

    <!-- Modal Contacts -->
    <div class="modal" id="contacts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-address-book"></i> <span id="contacts-modal-title">Contacts</span></h3>
                <button class="close-modal" onclick="closeContactsModal()">×</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher un contact..." id="search-contacts">
            </div>
            <div class="list-container" id="contacts-list"></div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient;
        let currentUser = null;
        let userProfile = null;
        let currentChatUser = null;
        let messageSubscription = null;
        let typingSubscription = null;
        let deliverySubscription = null;
        let conversationsCache = [];
        let contactsCache = [];
        let typingTimeout = null;
        let isTyping = false;
        let selectedImage = null;
        let messagesCache = [];

        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = 'connexion.html';
                return;
            }

            userProfile = await getUserProfile(currentUser.id);
            await initInterface();

            document.getElementById('search-conversations').addEventListener('input', (e) => filterList('conversations', e.target.value));
            document.getElementById('search-contacts').addEventListener('input', (e) => filterList('contacts', e.target.value));
        });

        async function initInterface() {
            if (userProfile.role === 'user') {
                document.getElementById('contacts-btn-text').textContent = 'Admins';
                document.getElementById('contacts-modal-title').textContent = 'Administrateurs';
                await initUserChat();
            } else {
                document.getElementById('contacts-btn-text').textContent = 'Contacts';
                document.getElementById('contacts-modal-title').textContent = 'Tous les contacts';
                await initAdminChat();
            }
        }

        async function initUserChat() {
            const storedAdminId = localStorage.getItem(`default_admin_${currentUser.id}`);
            let defaultAdmin = null;

            if (storedAdminId) {
                const { data } = await supabase
                    .from('users_profile')
                    .select('*')
                    .eq('user_id', storedAdminId)
                    .eq('role', 'admin')
                    .single();
                defaultAdmin = data;
            }

            if (!defaultAdmin) {
                const { data: admins } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .eq('role', 'admin')
                    .limit(10);

                if (admins && admins.length > 0) {
                    defaultAdmin = admins[Math.floor(Math.random() * admins.length)];
                    localStorage.setItem(`default_admin_${currentUser.id}`, defaultAdmin.user_id);
                }
            }

            if (defaultAdmin) {
                openChat(defaultAdmin);
            } else {
                showEmptyState('Aucun administrateur disponible', 'Veuillez réessayer plus tard');
            }

            await loadConversations();
        }

        async function initAdminChat() {
            await loadConversations();
            
            if (conversationsCache.length > 0) {
                openChat(conversationsCache[0].user);
            } else {
                showEmptyState('Aucune conversation', 'Attendez qu\'un utilisateur vous contacte');
            }
        }

        async function loadConversations() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, receiver_id, texte, image_url, date_created, read_status, delivery_status')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .order('date_created', { ascending: false })
                    .limit(200);

                if (error) throw error;

                const userIds = new Set();
                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    userIds.add(otherId);
                });

                if (userIds.size === 0) {
                    conversationsCache = [];
                    return;
                }

                const { data: users, error: usersError } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .in('user_id', Array.from(userIds));
if (usersError) throw usersError;

                const usersMap = {};
                users.forEach(u => { usersMap[u.user_id] = u; });

                const conversations = {};
                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    const otherUser = usersMap[otherId];

                    if (!otherUser) return;
                    if (userProfile.role === 'user' && otherUser.role !== 'admin') return;

                    if (!conversations[otherId]) {
                        conversations[otherId] = {
                            user: otherUser,
                            lastMessage: msg,
                            unread: 0
                        };
                    }
                    if (msg.receiver_id === currentUser.id && !msg.read_status) {
                        conversations[otherId].unread++;
                    }
                });

                conversationsCache = Object.values(conversations).sort((a, b) =>
                    new Date(b.lastMessage.date_created) - new Date(a.lastMessage.date_created)
                );

            } catch (error) {
                console.error('Erreur chargement conversations:', error);
                conversationsCache = [];
            }
        }

        function openConversationsModal() {
            displayConversations(conversationsCache);
            document.getElementById('conversations-modal').classList.add('show');
        }

        function closeConversationsModal() {
            document.getElementById('conversations-modal').classList.remove('show');
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversations-list');

            if (conversations.length === 0) {
                container.innerHTML = '<div class="loading"><i class="fas fa-inbox"></i><p>Aucune conversation</p></div>';
                return;
            }

            container.innerHTML = '';
            conversations.forEach(conv => {
                const initials = `${conv.user.prenom[0]}${conv.user.nom[0]}`.toUpperCase();
                const lastMsg = conv.lastMessage.image_url ? '📷 Photo' : (conv.lastMessage.texte?.substring(0, 50) || '📷 Photo');
                const time = formatTime(conv.lastMessage.date_created);
                const isUnread = conv.unread > 0;

                const div = document.createElement('div');
                div.className = 'list-item';
                if (currentChatUser && currentChatUser.user_id === conv.user.user_id) {
                    div.classList.add('active');
                }
                div.onclick = () => {
                    closeConversationsModal();
                    openChat(conv.user);
                };
                div.innerHTML = `
                    <div class="item-avatar">${initials}</div>
                    <div class="item-info">
                        <div class="item-header">
                            <span class="item-name">${conv.user.prenom} ${conv.user.nom}</span>
                            ${conv.user.role === 'admin' ? '<span class="item-role">Admin</span>' : ''}
                            <span class="item-time">${time}</span>
                        </div>
                        <div class="item-preview ${isUnread ? 'unread' : ''}">${lastMsg}</div>
                    </div>
                    ${conv.unread > 0 ? `<div class="item-unread">${conv.unread}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        async function loadContacts() {
            try {
                const role = userProfile.role === 'user' ? 'admin' : null;
                let query = supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .neq('user_id', currentUser.id)
                    .order('prenom')
                    .limit(100);

                if (role) {
                    query = query.eq('role', role);
                }

                const { data, error } = await query;
                if (error) throw error;
                contactsCache = data || [];
            } catch (error) {
                console.error('Erreur chargement contacts:', error);
                contactsCache = [];
            }
        }

        function openContactsModal() {
            if (contactsCache.length === 0) {
                document.getElementById('contacts-list').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>';
                document.getElementById('contacts-modal').classList.add('show');
                loadContacts().then(() => displayContacts(contactsCache));
            } else {
                displayContacts(contactsCache);
                document.getElementById('contacts-modal').classList.add('show');
            }
        }

        function closeContactsModal() {
            document.getElementById('contacts-modal').classList.remove('show');
        }

        function displayContacts(contacts) {
            const container = document.getElementById('contacts-list');

            if (contacts.length === 0) {
                container.innerHTML = '<div class="loading"><i class="fas fa-user-slash"></i><p>Aucun contact disponible</p></div>';
                return;
            }

            container.innerHTML = '';
            contacts.forEach(user => {
                const initials = `${user.prenom[0]}${user.nom[0]}`.toUpperCase();
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => {
                    closeContactsModal();
                    openChat(user);
                };
                div.innerHTML = `
                    <div class="item-avatar">${initials}</div>
                    <div class="item-info">
                        <div class="item-header">
                            <span class="item-name">${user.prenom} ${user.nom}</span>
                            ${user.role === 'admin' ? '<span class="item-role">Admin</span>' : ''}
                        </div>
                        <div class="item-preview">Démarrer une conversation</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterList(type, query) {
            const data = type === 'conversations' ? conversationsCache : contactsCache;
            const filtered = data.filter(item => {
                const user = item.user || item;
                return `${user.prenom} ${user.nom}`.toLowerCase().includes(query.toLowerCase());
            });

            if (type === 'conversations') {
                displayConversations(filtered);
            } else {
                displayContacts(filtered);
            }
        }

        function openChat(user) {
            currentChatUser = user;
            selectedImage = null;
            const initials = `${user.prenom[0]}${user.nom[0]}`.toUpperCase();
            const chatArea = document.getElementById('chat-area');

            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-avatar">${initials}</div>
                    <div class="chat-user-info">
                        <h3>${user.prenom} ${user.nom}</h3>
                        <p id="user-status">${user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}</p>
                    </div>
                    <div class="chat-header-actions">
                        <button class="chat-header-btn" onclick="refreshChat()" title="Actualiser">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="image-preview-container" id="image-preview-container">
                    <div class="image-preview">
                        <img id="preview-image" src="" alt="Preview">
                        <button class="remove-preview" onclick="removeImagePreview()">×</button>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <button class="attach-btn" onclick="document.getElementById('image-input').click()" title="Joindre une image">
                        <i class="fas fa-image"></i>
                    </button>
                    <div class="input-wrapper">
                        <textarea class="message-input" id="message-input" placeholder="Aa" rows="1" oninput="handleInputChange()" onkeydown="handleKeyDown(event)"></textarea>
                        <button class="emoji-btn" onclick="insertEmoji()" title="Emoji">
                            😊
                        </button>
                    </div>
                    <button class="send-btn" onclick="sendMessage()" id="send-btn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;

            loadMessages(user.user_id);
            markMessagesAsRead(user.user_id);
            subscribeToMessages(user.user_id);
            subscribeToTypingStatus(user.user_id);
            subscribeToDeliveryStatus(user.user_id);
            
            const input = document.getElementById('message-input');
            input.focus();
        }

        function handleInputChange() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            
            // Auto-resize textarea
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            
            // Update send button state
            const hasContent = input.value.trim().length > 0 || selectedImage !== null;
            sendBtn.disabled = !hasContent;
            
            // Typing indicator
            if (input.value.trim().length > 0 && !isTyping) {
                updateTypingStatus(true);
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                updateTypingStatus(false);
            }, 2000);
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = document.getElementById('message-input');
                if (input.value.trim().length > 0 || selectedImage !== null) {
                    sendMessage();
                }
            }
        }

        async function updateTypingStatus(typing) {
            if (!currentChatUser) return;
            isTyping = typing;
            
            try {
                if (typing) {
                    await supabase
                        .from('typing_status')
                        .upsert({
                            user_id: currentUser.id,
                            chat_with_user_id: currentChatUser.user_id,
                            is_typing: true
                        });
                } else {
                    await supabase
                        .from('typing_status')
                        .delete()
                        .eq('user_id', currentUser.id)
                        .eq('chat_with_user_id', currentChatUser.user_id);
                }
            } catch (error) {
                console.error('Erreur typing status:', error);
            }
        }

        function subscribeToTypingStatus(otherUserId) {
            if (typingSubscription) supabase.removeChannel(typingSubscription);

            typingSubscription = supabase.channel(`typing-${currentUser.id}-${otherUserId}`)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'typing_status',
                    filter: `user_id=eq.${otherUserId}`
                }, (payload) => {
                    const statusEl = document.getElementById('user-status');
                    if (!statusEl) return;
                    
                    if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                        if (payload.new.is_typing && payload.new.chat_with_user_id === currentUser.id) {
                            statusEl.innerHTML = '<span class="typing-indicator">En train d\'écrire<span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
                        }
                    } else if (payload.eventType === 'DELETE') {
                        statusEl.textContent = currentChatUser.role === 'admin' ? 'Administrateur' : 'Utilisateur';
                    }
                })
                .subscribe();
        }

        function subscribeToDeliveryStatus(otherUserId) {
            if (deliverySubscription) supabase.removeChannel(deliverySubscription);

            deliverySubscription = supabase.channel(`delivery-${currentUser.id}-${otherUserId}`)
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'messages',
                    filter: `sender_id=eq.${currentUser.id}`
                }, (payload) => {
                    updateMessageStatus(payload.new.message_id, payload.new.delivery_status, payload.new.read_status);
                })
                .subscribe();
        }

        function updateMessageStatus(messageId, deliveryStatus, readStatus) {
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageEl) return;

            const statusEl = messageEl.querySelector('.message-status');
            if (!statusEl) return;

            if (readStatus) {
                statusEl.innerHTML = '<i class="fas fa-check-double" style="color: #0084ff;"></i>';
            } else if (deliveryStatus === 'delivered') {
                statusEl.innerHTML = '<i class="fas fa-check-double"></i>';
            } else if (deliveryStatus === 'sent') {
                statusEl.innerHTML = '<i class="fas fa-check"></i>';
            }
        }

        async function loadMessages(otherUserId) {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, texte, image_url, date_created, delivery_status, read_status')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${otherUserId}),and(sender_id.eq.${otherUserId},receiver_id.eq.${currentUser.id})`)
                    .order('date_created', { ascending: true })
                    .limit(200);

                if (error) throw error;
                messagesCache = data || [];
                displayMessages(messagesCache);
            } catch (error) {
                console.error('Erreur chargement messages:', error);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('chat-messages');
            if (!container) return;

            const shouldScroll = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
            container.innerHTML = '';

            let currentDate = null;
            let lastSenderId = null;
            let messageGroup = [];

            messages.forEach((msg, index) => {
                const msgDate = new Date(msg.date_created).toDateString();
                
                // Date separator
                if (msgDate !== currentDate) {
                    if (messageGroup.length > 0) {
                        displayMessageGroup(container, messageGroup);
                        messageGroup = [];
                    }
                    
                    const separator = document.createElement('div');
                    separator.className = 'date-separator';
                    separator.innerHTML = `<span>${formatDateSeparator(msg.date_created)}</span>`;
                    container.appendChild(separator);
                    currentDate = msgDate;
                    lastSenderId = null;
                }

                // Group messages by sender
                if (msg.sender_id !== lastSenderId && messageGroup.length > 0) {
                    displayMessageGroup(container, messageGroup);
                    messageGroup = [];
                }

                messageGroup.push(msg);
                lastSenderId = msg.sender_id;

                // Display last group
                if (index === messages.length - 1) {
                    displayMessageGroup(container, messageGroup);
                }
            });

            if (shouldScroll) container.scrollTop = container.scrollHeight;
        }

        function displayMessageGroup(container, messages) {
            if (messages.length === 0) return;

            const groupDiv = document.createElement('div');
            groupDiv.className = 'message-group';

            messages.forEach((msg, index) => {
                const isSent = msg.sender_id === currentUser.id;
                const div = document.createElement('div');
                div.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;
                div.setAttribute('data-message-id', msg.message_id);

                // Position in group
                if (messages.length === 1) {
                    // Single message
                } else if (index === 0) {
                    div.classList.add('first-in-group');
                } else if (index === messages.length - 1) {
                    div.classList.add('last-in-group');
                } else {
                    div.classList.add('middle-in-group');
                }

                let content = '';
                if (msg.texte) content += `<div class="message-text">${escapeHtml(msg.texte)}</div>`;
                if (msg.image_url) content += `<img src="${msg.image_url}" class="message-image" onclick="openImageFullscreen('${msg.image_url}')">`;
                
                // Show time only on last message of group
                if (index === messages.length - 1) {
                    let statusIcon = '';
                    if (isSent) {
                        if (msg.read_status) {
                            statusIcon = '<span class="message-status"><i class="fas fa-check-double" style="color: #0084ff;"></i></span>';
                        } else if (msg.delivery_status === 'delivered') {
                            statusIcon = '<span class="message-status"><i class="fas fa-check-double"></i></span>';
                        } else if (msg.delivery_status === 'sent') {
                            statusIcon = '<span class="message-status"><i class="fas fa-check"></i></span>';
                        }
                    }
                    content += `<div class="message-time">${formatMessageTime(msg.date_created)} ${statusIcon}</div>`;
                }

                // Reaction picker
                content += `
                    <div class="reaction-picker">
                        <div class="reaction-emoji" onclick="addReaction('${msg.message_id}', '❤️', event)">❤️</div>
                        <div class="reaction-emoji" onclick="addReaction('${msg.message_id}', '😂', event)">😂</div>
                        <div class="reaction-emoji" onclick="addReaction('${msg.message_id}', '😮', event)">😮</div>
                        <div class="reaction-emoji" onclick="addReaction('${msg.message_id}', '😢', event)">😢</div>
                        <div class="reaction-emoji" onclick="addReaction('${msg.message_id}', '👍', event)">👍</div>
                        <div class="reaction-emoji" onclick="addReaction('${msg.message_id}', '👎', event)">👎</div>
                    </div>
                `;

                div.innerHTML = content;
                groupDiv.appendChild(div);
            });

            container.appendChild(groupDiv);
        }

        async function addReaction(messageId, emoji, event) {
            event.stopPropagation();
            
            // Big reaction animation (like Messenger)
            const animDiv = document.createElement('div');
            animDiv.className = 'big-reaction-animation';
            animDiv.textContent = emoji;
            document.body.appendChild(animDiv);
            
            setTimeout(() => {
                animDiv.remove();
            }, 1000);

            try {
                // Store reaction in article_reactions table (if you want to persist)
                // For now, just visual feedback
                console.log('Reaction added:', emoji, 'to message:', messageId);
            } catch (error) {
                console.error('Erreur ajout réaction:', error);
            }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 5000000) {
                alert('L\'image est trop volumineuse (max 5MB)');
                return;
            }

            selectedImage = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewContainer = document.getElementById('image-preview-container');
                const previewImage = document.getElementById('preview-image');
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
                
                handleInputChange();
            };
            reader.readAsDataURL(file);
        }

        function removeImagePreview() {
            selectedImage = null;
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('image-input').value = '';
            handleInputChange();
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const texte = input ? input.value.trim() : '';

            if (!texte && !selectedImage) return;

            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }

            updateTypingStatus(false);

            try {
                let imageUrl = null;
                if (selectedImage) {
                    const fileName = `${Date.now()}_${selectedImage.name}`;
                    const metadata = {
                        sender_id: currentUser.id,
                        receiver_id: currentChatUser.user_id
                    };
                    
                    const { error: uploadError } = await supabase.storage
                        .from('messages-images')
                        .upload(fileName, selectedImage, {
                            contentType: selectedImage.type,
                            upsert: false,
                            metadata: metadata
                        });

                    if (uploadError) throw uploadError;
                    const { data } = supabase.storage.from('messages-images').getPublicUrl(fileName);
                    imageUrl = data.publicUrl;
                }

                const { error: insertError } = await supabase.from('messages').insert({
                    sender_id: currentUser.id,
                    receiver_id: currentChatUser.user_id,
                    texte: texte || null,
                    image_url: imageUrl,
                    delivery_status: 'sent'
                });

                if (insertError) throw insertError;

                if (input) {
                    input.value = '';
                    input.style.height = 'auto';
                    input.focus();
                }
                
                removeImagePreview();
                
            } catch (error) {
                console.error('Erreur envoi message:', error);
                alert('Erreur lors de l\'envoi du message. Veuillez réessayer.');
            } finally {
                if (sendBtn) {
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    handleInputChange();
                }
            }
        }

        async function markMessagesAsRead(otherUserId) {
            try {
                await supabase
                    .from('messages')
                    .update({ 
                        read_status: true, 
                        delivery_status: 'read',
                        read_at: new Date().toISOString()
                    })
                    .eq('sender_id', otherUserId)
                    .eq('receiver_id', currentUser.id)
                    .eq('read_status', false);
                    
                await loadConversations();
            } catch (error) {
                console.error('Erreur marquage lu:', error);
            }
        }

        function subscribeToMessages(otherUserId) {
            if (messageSubscription) supabase.removeChannel(messageSubscription);

            messageSubscription = supabase.channel(`chat-${currentUser.id}-${otherUserId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    if ((payload.new.sender_id === otherUserId && payload.new.receiver_id === currentUser.id) ||
                        (payload.new.sender_id === currentUser.id && payload.new.receiver_id === otherUserId)) {
                        
                        messagesCache.push(payload.new);
                        displayMessages(messagesCache);
                        
                        if (payload.new.receiver_id === currentUser.id) {
                            markMessagesAsRead(otherUserId);
                        }
                        
                        loadConversations();
                    }
                })
                .subscribe();
        }

        function refreshChat() {
            if (currentChatUser) {
                loadMessages(currentChatUser.user_id);
                loadConversations();
            }
        }

        function showEmptyState(title, subtitle = '') {
            document.getElementById('chat-area').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>${title}</h3>
                    ${subtitle ? `<p>${subtitle}</p>` : ''}
                </div>
            `;
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'À l\'instant';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} min`;
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'Hier';
            }
            
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function formatMessageTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateSeparator(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return 'Aujourd\'hui';
            }
            
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'Hier';
            }
            
            return date.toLocaleDateString('fr-FR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function insertEmoji() {
            const emojis = ['😊', '😂', '❤️', '👍', '🎉', '🔥', '😍', '🤔', '👏', '🙏'];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            const input = document.getElementById('message-input');
            if (input) {
                input.value += emoji;
                input.focus();
                handleInputChange();
            }
        }

        function openImageFullscreen(imageUrl) {
            window.open(imageUrl, '_blank');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Close modals on outside click
        document.getElementById('conversations-modal').addEventListener('click', function(e) {
            if (e.target === this) closeConversationsModal();
        });

        document.getElementById('contacts-modal').addEventListener('click', function(e) {
            if (e.target === this) closeContactsModal();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            updateTypingStatus(false);
            if (messageSubscription) supabase.removeChannel(messageSubscription);
            if (typingSubscription) supabase.removeChannel(typingSubscription);
            if (deliverySubscription) supabase.removeChannel(deliverySubscription);
        });

        // Auto-refresh conversations every 30 seconds
        setInterval(() => {
            if (!document.hidden) {
                loadConversations();
            }
        }, 30000);
    </script>
</body>
</html>
